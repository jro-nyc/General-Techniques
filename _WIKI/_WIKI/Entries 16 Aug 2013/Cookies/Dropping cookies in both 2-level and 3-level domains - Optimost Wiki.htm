<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" dir="ltr" lang="en"><head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<meta name="generator" content="MediaWiki 1.13.1">
		<meta name="keywords" content="Dropping cookies in both 2-level and 3-level domains">
		<link rel="shortcut icon" href="http://wiki.interwoven.com/favicon.ico">
		<link rel="search" type="application/opensearchdescription+xml" href="http://wiki.interwoven.com/opwiki/opensearch_desc.php" title="Optimost Wiki (en)">
		<link rel="alternate" type="application/rss+xml" title="Optimost Wiki RSS Feed" href="http://wiki.interwoven.com/opwiki/index.php?title=Special:RecentChanges&amp;feed=rss">
		<link rel="alternate" type="application/atom+xml" title="Optimost Wiki Atom Feed" href="http://wiki.interwoven.com/opwiki/index.php?title=Special:RecentChanges&amp;feed=atom">
		<title>Dropping cookies in both 2-level and 3-level domains - Optimost Wiki</title>
		<style type="text/css" media="screen, projection">/*<![CDATA[*/
			@import "/opwiki/skins/common/shared.css?164";
			@import "/opwiki/skins/monobook/main.css?164";
		/*]]>*/</style>
		<link rel="stylesheet" type="text/css" media="print" href="Dropping%20cookies%20in%20both%202-level%20and%203-level%20domains%20-%20Optimost%20Wiki_files/commonPrint.css">
		<!--[if lt IE 5.5000]><style type="text/css">@import "/opwiki/skins/monobook/IE50Fixes.css?164";</style><![endif]-->
		<!--[if IE 5.5000]><style type="text/css">@import "/opwiki/skins/monobook/IE55Fixes.css?164";</style><![endif]-->
		<!--[if IE 6]><style type="text/css">@import "/opwiki/skins/monobook/IE60Fixes.css?164";</style><![endif]-->
		<!--[if IE 7]><style type="text/css">@import "/opwiki/skins/monobook/IE70Fixes.css?164";</style><![endif]-->
		<!--[if lt IE 7]><script type="text/javascript" src="/opwiki/skins/common/IEFixes.js?164"></script>
		<meta http-equiv="imagetoolbar" content="no" /><![endif]-->
		
		<script type="text/javascript">/*<![CDATA[*/
var skin = "monobook";
var stylepath = "/opwiki/skins";
var wgArticlePath = "/optimost/$1";
var wgScriptPath = "/opwiki";
var wgScript = "/opwiki/index.php";
var wgVariantArticlePath = false;
var wgActionPaths = [];
var wgServer = "http://wiki.interwoven.com";
var wgCanonicalNamespace = "";
var wgCanonicalSpecialPageName = false;
var wgNamespaceNumber = 0;
var wgPageName = "Dropping_cookies_in_both_2-level_and_3-level_domains";
var wgTitle = "Dropping cookies in both 2-level and 3-level domains";
var wgAction = "view";
var wgArticleId = "814";
var wgIsArticle = true;
var wgUserName = null;
var wgUserGroups = null;
var wgUserLanguage = "en";
var wgContentLanguage = "en";
var wgBreakFrames = false;
var wgCurRevisionId = "5588";
var wgVersion = "1.13.1";
var wgEnableAPI = true;
var wgEnableWriteAPI = false;
var wgRestrictionEdit = [];
var wgRestrictionMove = [];
/*]]>*/</script>
                
		<script type="text/javascript" src="Dropping%20cookies%20in%20both%202-level%20and%203-level%20domains%20-%20Optimost%20Wiki_files/wikibits.js"><!-- wikibits js --></script>
		<!-- Head Scripts -->
		<script type="text/javascript" src="Dropping%20cookies%20in%20both%202-level%20and%203-level%20domains%20-%20Optimost%20Wiki_files/ajax.js"></script>
		<script type="text/javascript" src="Dropping%20cookies%20in%20both%202-level%20and%203-level%20domains%20-%20Optimost%20Wiki_files/index.php"><!-- site js --></script><script type="text/javascript" src="Dropping%20cookies%20in%20both%202-level%20and%203-level%20domains%20-%20Optimost%20Wiki_files/index_002.php"></script>
		<style type="text/css">/*<![CDATA[*/
@import "/opwiki/index.php?title=MediaWiki:Common.css&usemsgcache=yes&action=raw&ctype=text/css&smaxage=18000";
@import "/opwiki/index.php?title=MediaWiki:Monobook.css&usemsgcache=yes&action=raw&ctype=text/css&smaxage=18000";
@import "/opwiki/index.php?title=-&action=raw&gen=css&maxage=18000";
/*]]>*/</style>
	</head>
<body class="mediawiki ns-0 ltr page-Dropping_cookies_in_both_2-level_and_3-level_domains">
	<div id="globalWrapper">
		<div id="column-content">
	<div id="content">
		<a name="top" id="top"></a>
				<h1 class="firstHeading">Dropping cookies in both 2-level and 3-level domains</h1>
		<div id="bodyContent">
			<h3 id="siteSub">From Optimost Wiki</h3>
			<div id="contentSub"></div>
									<div id="jump-to-nav">Jump to: <a href="#column-one">navigation</a>, <a href="#searchInput">search</a></div>			<!-- start content -->
			<table id="toc" class="toc" summary="Contents"><tbody><tr><td><div id="toctitle"><h2>Contents</h2> <span class="toctoggle">[<a href="javascript:toggleToc()" class="internal" id="togglelink">hide</a>]</span></div>
<ul>
<li class="toclevel-1"><a href="#Introduction"><span class="tocnumber">1</span> <span class="toctext">Introduction</span></a>
<ul>
<li class="toclevel-2"><a href="#What_our_code_does"><span class="tocnumber">1.1</span> <span class="toctext">What our code does</span></a>
<ul>
<li class="toclevel-3"><a href="#Why_not_do_the_full_domain_in_the_address_bar.3F"><span class="tocnumber">1.1.1</span> <span class="toctext">Why not do the full domain in the address bar?</span></a></li>
<li class="toclevel-3"><a href="#Why_do_we_assume_2-levels"><span class="tocnumber">1.1.2</span> <span class="toctext">Why do we assume 2-levels</span></a></li>
<li class="toclevel-3"><a href="#What_comes_back_in_the_Trial_Code_call"><span class="tocnumber">1.1.3</span> <span class="toctext">What comes back in the Trial Code call</span></a></li>
</ul>
</li>
<li class="toclevel-2"><a href="#How_to_workaround_the_problem"><span class="tocnumber">1.2</span> <span class="toctext">How to workaround the problem</span></a>
<ul>
<li class="toclevel-3"><a href="#The_workaround"><span class="tocnumber">1.2.1</span> <span class="toctext">The workaround</span></a></li>
<li class="toclevel-3"><a href="#How_the_code_works"><span class="tocnumber">1.2.2</span> <span class="toctext">How the code works</span></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</td></tr></tbody></table><script type="text/javascript"> if (window.showTocToggle) { var tocShowText = "show"; var tocHideText = "hide"; showTocToggle(); } </script>
<a name="Introduction"></a><h1> <span class="mw-headline">Introduction</span></h1>
<p>If you are using First-party Activity Tracking or Stickiness, the 
Optimost Console gives you the option to either hard-code the cookies 
domain OR use the domain in the Address bar.  The system defaults to the
 domain in the Address bar, and if you are dealing with a website with a
 2-level base domain - say <b>bofa.com</b>, <b>cnn.com</b>, <b>friendscout.de</b> - then you are set.  However, if you are dealing with a website with a 3-level base domain - say <b>rightmove.co.uk</b>, <b>bmw.com.cn</b>
 - then you will have to use the hardcoding option to enter the base 
domain.  And if your experiment spans both 2 and 3-level base domains, 
or multiple 3-level base domains, then the system cannot handle it.  
This wiki entry proposes a workaround for this last scenario. 
</p>
<a name="What_our_code_does"></a><h2> <span class="mw-headline">What our code does</span></h2>
<p>Optimost drops cookies using two function: 
</p>
<ol><li><b>opCreativeSetCookieA(name, val, domain, time)</b> - Drops a cookie 
</li><li><b>opCreativeGetDocumentSLD()</b> - Figures out the name of base domain, and assumes it is 2-level.
</li></ol>
<a name="Why_not_do_the_full_domain_in_the_address_bar.3F"></a><h3> <span class="mw-headline">Why not do the full domain in the address bar?</span></h3>
<p>Now we don't have to pass a domain - we can use the full-domain in 
the address bar.  But for many sites, you may stay within the same base 
domain but change domains within the website as you navigate, so if you 
use the full domain, the cookie may not be visible downstream.  It is 
not uncommon to go from say <b>www.acme.com</b> and end up in <b>shop.acme.com</b>.  
</p>
<a name="Why_do_we_assume_2-levels"></a><h3> <span class="mw-headline">Why do we assume 2-levels</span></h3>
<p>Well, first off, the Internet started off here in the good old US of 
A, and all we had originally was 2-level domains.  So far so good.  But 
then we realized that there were other countries in the world - many of 
whom it turns out don't even speak English - so they got their own 
domains and we allowed them to administer the domains themselves, and in
 exchange they either bought our Treasury bonds, or sold us their beer. 
 And they often chose to have 3 level base domains, like <b>bmw.com.cn</b> or <b>rightmove.co.uk</b>.
</p><p>Problem is we can't universally differentiate between all 2 and 
3-level base domains easily without adding a "cheat sheet" of potential 
domains.  So the code assumes 2-level, if its 3 level, hard-code it into
 the Console.  
</p>
<a name="What_comes_back_in_the_Trial_Code_call"></a><h3> <span class="mw-headline">What comes back in the Trial Code call</span></h3>
<p>To show you how it works, below is an example of code coming back in 
the Trial Code call to set cookies.  I have done this so the sticky 
cookie is set to a hard-coded domain - <b>bmw.com.cn</b> - and the 
Activity Tracking cookie uses the domain in the Address bar.  Here is 
what the Trial Code call would return for setting the cookies:
</p><p><br>
</p>
<pre>function opCreativeSetCookieA(n, v, d, e){
	var de = new Date;
	de.setTime(de.getTime() + e * 1000);
	document.cookie = n + "=" + escape(v) + ((e==null)&nbsp;? ""&nbsp;: ("; expires=" + de.toGMTString())) + 
	"; path=/" + ((d==null)&nbsp;? ""&nbsp;: (";domain=" + d));
}
function opCreativeGetDocumentSLD(){
	var sld = document.domain;
	var dp = sld.split(".");
	var l = dp.length;
	if (l &lt; 2) sld = null;
	else if (!isNaN(dp[l-1]) &amp;&amp;&nbsp;!isNaN(dp[l-2])) sld = null;
	else sld = "." + dp[l-2] + "." + dp[l-1];
	return sld;
}
opCreativeSetCookieA("op497heroimageliid", "a00l02205825cfm11v76m2649", opCreativeGetDocumentSLD(), 604800);
opCreativeSetCookieA("op497heroimagegum", "a00l02205825cfm11v76m2649", ".bmw.com.cn", 86400);
</pre>
<p>This is just an example to show how the two options in the console 
are executed.  Note that if this were a real deployment and the domain 
IS NOT <b>bmw.com.cn</b> the cookie will not be dropped, so in this case the domain must be <b>bmw.com.cn</b> in order for both to be dropped.
</p>
<a name="How_to_workaround_the_problem"></a><h2> <span class="mw-headline">How to workaround the problem</span></h2>
<p>As I said, we can't have code that differentiates between all 2 and 
3-level domains.  BUT we can write a cheat sheet of "potential domains" 
tailored to our specific test and work around it.  
</p>
<a name="The_workaround"></a><h3> <span class="mw-headline">The workaround</span></h3>
<p>Modify the function that pulls the domain to check a list of 
potential base domains that are stored in an array, and if domain in the
 address bar contains the base domain in the array, then use the base 
domain in our array as the domain to drop the cookie in.
</p>
<a name="How_the_code_works"></a><h3> <span class="mw-headline">How the code works</span></h3>
<pre>&lt;script&gt;
var otDomainsArray=["bmw.com.cn","mcon.net","optimost.com"];
function opCreativeSetCookieA(n, v, d, e){var de = new Date;de.setTime(de.getTime() + e * 1000);document.cookie = n + "=" + escape(v) + ((e==null)&nbsp;? ""&nbsp;: ("; expires=" + de.toGMTString())) + "; path=/" + ((d==null)&nbsp;? ""&nbsp;: (";domain=" + d));}
function opCreativeGetDocumentSLD_INTL(){
	sld = document.domain;
	var dp = sld.split(".");
        var l=dp.length;
	if (l &lt; 2) returnedSLD=null;
        else if (!isNaN(dp[l - 1]) &amp;&amp;&nbsp;!isNaN(dp[l - 2])) returnedSLD = null;
	else returnedSLD="."+dp[l-2]+'.'+dp[l-1];
	for(var i=0;i&lt;otDomainsArray.length;i++){
		if(sld.indexOf(otDomainsArray[i])!=-1){
			returnedSLD="."+otDomainsArray[i];                        
			break;
		}
	}
	return returnedSLD;	
}
opCreativeSetCookieA("op590philips_us_shopping_cartgum", "{{$creative.sessionId}}", opCreativeGetDocumentSLD_INTL(), 604800);
opCreativeSetCookieA("op590philips_us_shopping_cartliid", "{{$creative.sessionId}}", opCreativeGetDocumentSLD_INTL(), 86400);
&lt;/script&gt;
</pre>
<p>For the code:
</p>
<ol><li>Make sure to put the 3-level domains first in the array, and 
2-level last.  In case you have a 2-level within a 3-level, you need to 
check for the 3-level first to not get a false positive on a 2-level. 
For example, if your test is running on <b>acme.com</b> and <b>acme.com.uk</b>, <b>acme.com</b> matches both, so put that after <b>acme.co.uk</b> in the array.
</li><li>Put this code at the top of your setup block, so it will 
execute immediately after the "default" cookie setting code in the Trial
 Code has executed.
</li><li>I used <b>optimost.com</b> as a domain since we often run tests on our <b>kidwww.optimost.com</b> servers as a "pseudo" functional QA.  If you have some test domain you use, you may want to enter it.
</li></ol>
<p><br>
</p>
<!-- 
NewPP limit report
Preprocessor node count: 15/1000000
Post-expand include size: 0/2097152 bytes
Template argument size: 0/2097152 bytes
Expensive parser function count: 0/100
-->

<!-- Saved in parser cache with key optimost_wiki:pcache:idhash:814-0!1!0!!en!2!edit=0 and timestamp 20130815154128 -->
<div class="printfooter">
Retrieved from "<a href="http://wiki.interwoven.com/optimost/Dropping_cookies_in_both_2-level_and_3-level_domains">http://wiki.interwoven.com/optimost/Dropping_cookies_in_both_2-level_and_3-level_domains</a>"</div>
						<!-- end content -->
			<div class="visualClear"></div>
		</div>
	</div>
		</div>
		<div id="column-one">
	<div id="p-cactions" class="portlet">
		<h5>Views</h5>
		<div class="pBody">
			<ul>
	
				 <li id="ca-nstab-main" class="selected"><a href="http://wiki.interwoven.com/optimost/Dropping_cookies_in_both_2-level_and_3-level_domains" title="View the content page [alt-shift-c]" accesskey="c">Page</a></li>
				 <li id="ca-talk" class="new"><a href="http://wiki.interwoven.com/opwiki/index.php?title=Talk:Dropping_cookies_in_both_2-level_and_3-level_domains&amp;action=edit" title="Discussion about the content page [alt-shift-t]" accesskey="t">Discussion</a></li>
				 <li id="ca-viewsource"><a href="http://wiki.interwoven.com/opwiki/index.php?title=Dropping_cookies_in_both_2-level_and_3-level_domains&amp;action=edit" title="This page is protected.
You can view its source. [alt-shift-e]" accesskey="e">View source</a></li>
				 <li id="ca-history"><a href="http://wiki.interwoven.com/opwiki/index.php?title=Dropping_cookies_in_both_2-level_and_3-level_domains&amp;action=history" title="Past versions of this page. [alt-shift-h]" accesskey="h">History</a></li>			</ul>
		</div>
	</div>
	<div class="portlet" id="p-personal">
		<h5>Personal tools</h5>
		<div class="pBody">
			<ul>
				<li id="pt-anonuserpage"><a href="http://wiki.interwoven.com/optimost/User:10.26.10.11" title="The user page for the ip you're editing as [alt-shift-.]" accesskey="." class="new">10.26.10.11</a></li>
				<li id="pt-anontalk"><a href="http://wiki.interwoven.com/optimost/User_talk:10.26.10.11" title="Discussion about edits from this ip address [alt-shift-n]" accesskey="n" class="new">Talk for this IP</a></li>
				<li id="pt-anonlogin"><a href="http://wiki.interwoven.com/opwiki/index.php?title=Special:UserLogin&amp;returnto=Dropping_cookies_in_both_2-level_and_3-level_domains" title="You are encouraged to log in, it is not mandatory however. [alt-shift-o]" accesskey="o">Log in / create account</a></li>
			</ul>
		</div>
	</div>
	<div class="portlet" id="p-logo">
		<a style="background-image: url(http://wiki.interwoven.com/opwiki/images/1/18/Logo_optimost.gif);" href="http://wiki.interwoven.com/optimost/Home" title="Visit the Main Page [alt-shift-z]" accesskey="z"></a>
	</div>
	<script type="text/javascript"> if (window.isMSIE55) fixalpha(); </script>
	<div id="p-search" class="portlet">
		<h5><label for="searchInput">Search</label></h5>
		<div id="searchBody" class="pBody">
			<form action="/optimost/Special:Search" id="searchform"><div>
				<input id="searchInput" name="search" title="Search Optimost Wiki [alt-shift-f]" accesskey="f" type="text">
				<input name="go" class="searchButton" id="searchGoButton" value="Go" title="Go to a page with this exact name if exists" type="submit">&nbsp;
				<input name="fulltext" class="searchButton" id="mw-searchButton" value="Search" title="Search the pages for this text" type="submit">
			</div></form>
		</div>
	</div>
	<div class="generated-sidebar portlet" id="p-navigation">
		<h5>Navigation</h5>
		<div class="pBody">
			<ul>
				<li id="n-mainpage"><a href="http://wiki.interwoven.com/optimost/Home" title="Visit the Main Page [alt-shift-z]" accesskey="z">Home</a></li>
				<li id="n-recentchanges"><a href="http://wiki.interwoven.com/optimost/Special:RecentChanges" title="The list of recent changes in the wiki. [alt-shift-r]" accesskey="r">Recent changes</a></li>
				<li id="n-randompage"><a href="http://wiki.interwoven.com/optimost/Special:Random" title="Load a random page [alt-shift-x]" accesskey="x">Random page</a></li>
				<li id="n-Accounts"><a href="http://wiki.interwoven.com/optimost/Accounts">Accounts</a></li>
				<li id="n-Glossary"><a href="http://wiki.interwoven.com/optimost/Glossary">Glossary</a></li>
				<li id="n-help"><a href="http://wiki.interwoven.com/optimost/Help:Contents" title="The place to find out.">Help</a></li>
			</ul>
		</div>
	</div>
	<div class="generated-sidebar portlet" id="p-departments">
		<h5>departments</h5>
		<div class="pBody">
			<ul>
				<li id="n-Analytics"><a href="http://wiki.interwoven.com/optimost/Analytics_%28Department%29">Analytics</a></li>
				<li id="n-Client-Services"><a href="http://wiki.interwoven.com/optimost/Category:Client_Services">Client Services</a></li>
				<li id="n-Documentation"><a href="http://wiki.interwoven.com/optimost/Documentation">Documentation</a></li>
				<li id="n-Engineering"><a href="http://wiki.interwoven.com/optimost/Engineering">Engineering</a></li>
				<li id="n-Quality-Assurance"><a href="http://wiki.interwoven.com/optimost/Category:Quality_Assurance">Quality Assurance</a></li>
				<li id="n-Technical-Consulting"><a href="http://wiki.interwoven.com/optimost/Technical_consulting">Technical Consulting</a></li>
				<li id="n-Training-.26-Education"><a href="http://wiki.interwoven.com/optimost/Training_and_education">Training &amp; Education</a></li>
			</ul>
		</div>
	</div>
	<div class="generated-sidebar portlet" id="p-links">
		<h5>links</h5>
		<div class="pBody">
			<ul>
				<li id="n-Optimost-Console"><a href="http://asp.optimost.com/agency">Optimost Console</a></li>
				<li id="n-Optimost-Public-Site"><a href="http://www.interwoven.com/optimost">Optimost Public Site</a></li>
				<li id="n-Netspeed"><a href="http://netspeed/">Netspeed</a></li>
				<li id="n-SalesSite"><a href="http://salessite/">SalesSite</a></li>
				<li id="n-WorkSite"><a href="https://worksitemp.interwoven.com/worksitemp/link//V3/INTERWOVEN/C/F$217/C$14610/">WorkSite</a></li>
			</ul>
		</div>
	</div>
	<div class="portlet" id="p-tb">
		<h5>Toolbox</h5>
		<div class="pBody">
			<ul>
				<li id="t-whatlinkshere"><a href="http://wiki.interwoven.com/optimost/Special:WhatLinksHere/Dropping_cookies_in_both_2-level_and_3-level_domains" title="List of all wiki pages that link here [alt-shift-j]" accesskey="j">What links here</a></li>
				<li id="t-recentchangeslinked"><a href="http://wiki.interwoven.com/optimost/Special:RecentChangesLinked/Dropping_cookies_in_both_2-level_and_3-level_domains" title="Recent changes in pages linked from this page [alt-shift-k]" accesskey="k">Related changes</a></li>
<li id="t-upload"><a href="http://wiki.interwoven.com/optimost/Special:Upload" title="Upload files [alt-shift-u]" accesskey="u">Upload file</a></li>
<li id="t-specialpages"><a href="http://wiki.interwoven.com/optimost/Special:SpecialPages" title="List of all special pages [alt-shift-q]" accesskey="q">Special pages</a></li>
				<li id="t-print"><a href="http://wiki.interwoven.com/opwiki/index.php?title=Dropping_cookies_in_both_2-level_and_3-level_domains&amp;printable=yes" title="Printable version of this page [alt-shift-p]" accesskey="p">Printable version</a></li>				<li id="t-permalink"><a href="http://wiki.interwoven.com/opwiki/index.php?title=Dropping_cookies_in_both_2-level_and_3-level_domains&amp;oldid=5588" title="Permanent link to this version of the page">Permanent link</a></li>			</ul>
		</div>
	</div>
		</div><!-- end of the left (by default at least) column -->
			<div class="visualClear"></div>
			<div id="footer">
				<div id="f-poweredbyico"><a href="http://www.mediawiki.org/"><img src="Dropping%20cookies%20in%20both%202-level%20and%203-level%20domains%20-%20Optimost%20Wiki_files/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki"></a></div>
			<ul id="f-list">
				<li id="lastmod"> This page was last modified on 19 January 2011, at 15:24.</li>
				<li id="viewcount">This page has been accessed 73 times.</li>
				<li id="privacy"><a href="http://wiki.interwoven.com/optimost/Optimost_Wiki:Privacy_policy" title="Optimost Wiki:Privacy policy">Privacy policy</a></li>
				<li id="about"><a href="http://wiki.interwoven.com/optimost/Optimost_Wiki:About" title="Optimost Wiki:About">About Optimost Wiki</a></li>
				<li id="disclaimer"><a href="http://wiki.interwoven.com/optimost/Optimost_Wiki:General_disclaimer" title="Optimost Wiki:General disclaimer">Disclaimers</a></li>
			</ul>
		</div>
</div>

		<script type="text/javascript">if (window.runOnloadHook) runOnloadHook();</script>
<!-- Served in 0.154 secs. -->
</body></html>